import{_ as F,m as n,p as R,o as i,c as r,b as o,F as P,r as A,t as a,d as m,v as k,w as D,e as c,f as S,n as H}from"./index-0403a620.js";import{w as v}from"./index-8cce7ed6.js";const z={class:"workflow-manage"},q={class:"workflow-list"},X={class:"workflow-header"},Y={class:"workflow-code"},G={class:"workflow-info"},K={class:"info-item"},Q={class:"info-value"},Z={class:"info-item"},j={class:"info-value"},ee={class:"workflow-actions-row"},oe=["onClick"],se=["onClick"],te=["onClick"],le=["onClick"],ae=["onClick"],ne=["onClick"],ie={class:"dialog-content"},re={class:"form-row"},de={class:"form-group"},ue=["disabled"],ce={class:"form-group"},ve={class:"form-group"},fe={class:"form-group"},pe={class:"dialog-content"},we={class:"view-section"},me={class:"view-section"},ke={class:"json-view"},ge={class:"dialog-content"},Ce={class:"form-group"},ye={key:0,class:"test-result"},be={__name:"WorkflowManage",setup(_e){const W=n([]),g=n(!1),b=n(!1),_=n(!1),C=n("create"),l=n({}),d=n({}),y=n({}),f=n(""),u=n(null),J=s=>s?new Date(s).toLocaleString("zh-CN"):"",h=s=>{try{return JSON.stringify(typeof s=="string"?JSON.parse(s):s,null,2)}catch{return s}},p=async()=>{try{const s=await v.listWorkflows();s.data&&s.data.success&&(W.value=s.data.data)}catch(s){console.error("获取流程列表失败:",s),alert("获取流程列表失败")}},I=()=>{C.value="create";const s={workflowCode:"FLOW_EXAMPLE",workflowName:"示例流程",nodes:[{nodeId:"start",nodeType:"start"},{nodeId:"service1",nodeType:"service",serviceCode:"USER_VERIFY",inputMapping:{userId:"${context.userId}"},outputMapping:{verifyResult:"verified"}},{nodeId:"end",nodeType:"end"}],edges:[{from:"start",to:"service1"},{from:"service1",to:"end"}]};l.value={workflowCode:"",workflowName:"",productCode:"",flowDefinition:JSON.stringify(s,null,2)},g.value=!0},V=s=>{C.value="edit",l.value={id:s.id,workflowCode:s.workflowCode,workflowName:s.workflowName,productCode:s.productCode,flowDefinition:h(s.flowDefinition)},g.value=!0},M=s=>{d.value=s,b.value=!0},T=async()=>{try{try{JSON.parse(l.value.flowDefinition)}catch{alert("流程定义JSON格式不正确");return}const s=await v.saveWorkflow(l.value);s.data&&s.data.success?(alert("保存成功"),N(),await p()):alert("保存失败: "+(s.data?s.data.message:"未知错误"))}catch(s){console.error("保存流程失败:",s),alert("保存失败")}},U=async s=>{if(confirm(`确定要发布流程"${s.workflowName}"吗？`))try{const e=await v.publishWorkflow(s.id);e.data&&e.data.success?(alert("发布成功"),await p()):alert("发布失败: "+(e.data?e.data.message:"未知错误"))}catch(e){console.error("发布流程失败:",e),alert("发布失败")}},$=async s=>{if(confirm(`确定要下线流程"${s.workflowName}"吗？`))try{const e=await v.unpublishWorkflow(s.id);e.data&&e.data.success?(alert("下线成功"),await p()):alert("下线失败: "+(e.data?e.data.message:"未知错误"))}catch(e){console.error("下线流程失败:",e),alert("下线失败")}},E=async s=>{if(confirm(`确定要删除流程"${s.workflowName}"吗？此操作不可恢复！`))try{const e=await v.deleteWorkflow(s.id);e.data&&e.data.success?(alert("删除成功"),await p()):alert("删除失败: "+(e.data?e.data.message:"未知错误"))}catch(e){console.error("删除流程失败:",e),alert("删除失败")}},L=s=>{y.value=s,f.value=JSON.stringify({userId:"U001",productCode:s.productCode,amount:1e4,quantity:1},null,2),u.value=null,_.value=!0},B=async()=>{try{const s=JSON.parse(f.value),e=await v.testWorkflow(y.value.workflowCode,s);u.value=JSON.stringify(e.data||e,null,2)}catch(s){console.error("测试流程失败:",s),u.value=JSON.stringify({error:s.message},null,2)}},N=()=>{g.value=!1,l.value={}},x=()=>{b.value=!1,d.value={}},O=()=>{_.value=!1,y.value={},f.value="",u.value=null};return R(()=>{p()}),(s,e)=>(i(),r("div",z,[e[22]||(e[22]=o("div",{class:"page-header"},[o("h2",null,"流程编排管理"),o("p",{class:"page-desc"},"配置和管理产品购买流程")],-1)),o("div",{class:"workflow-actions"},[o("button",{onClick:I,class:"btn-create"},"+ 新建流程")]),o("div",q,[(i(!0),r(P,null,A(W.value,t=>(i(),r("div",{key:t.id,class:"workflow-card"},[o("div",X,[o("div",null,[o("h3",null,a(t.workflowName),1),o("p",Y,a(t.workflowCode),1)]),o("div",null,[o("span",{class:H(["status-badge",t.status])},a(t.status==="PUBLISHED"?"已发布":"草稿"),3)])]),o("div",G,[o("div",K,[e[8]||(e[8]=o("span",{class:"info-label"},"关联产品:",-1)),o("span",Q,a(t.productCode),1)]),o("div",Z,[e[9]||(e[9]=o("span",{class:"info-label"},"更新时间:",-1)),o("span",j,a(J(t.updateTime)),1)])]),o("div",ee,[o("button",{onClick:w=>M(t),class:"btn-view"},"查看流程",8,oe),o("button",{onClick:w=>V(t),class:"btn-edit"},"编辑",8,se),t.status==="DRAFT"?(i(),r("button",{key:0,onClick:w=>U(t),class:"btn-publish"},"发布",8,te)):c("",!0),t.status==="PUBLISHED"?(i(),r("button",{key:1,onClick:w=>$(t),class:"btn-unpublish"},"下线",8,le)):c("",!0),o("button",{onClick:w=>L(t),class:"btn-test"},"测试",8,ae),o("button",{onClick:w=>E(t),class:"btn-delete"},"删除",8,ne)])]))),128))]),g.value?(i(),r("div",{key:0,class:"dialog-overlay",onClick:N},[o("div",{class:"dialog-large",onClick:e[4]||(e[4]=D(()=>{},["stop"]))},[o("h3",null,a(C.value==="create"?"新建流程":"编辑流程"),1),o("div",ie,[o("div",re,[o("div",de,[e[10]||(e[10]=o("label",null,"流程编号 *",-1)),m(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.workflowCode=t),disabled:C.value==="edit",class:"form-input"},null,8,ue),[[k,l.value.workflowCode]])]),o("div",ce,[e[11]||(e[11]=o("label",null,"流程名称 *",-1)),m(o("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.workflowName=t),class:"form-input"},null,512),[[k,l.value.workflowName]])])]),o("div",ve,[e[12]||(e[12]=o("label",null,"关联产品编号 *",-1)),m(o("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>l.value.productCode=t),class:"form-input"},null,512),[[k,l.value.productCode]])]),o("div",fe,[e[13]||(e[13]=o("label",null,"流程定义 (JSON格式) *",-1)),m(o("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.flowDefinition=t),rows:"20",class:"form-textarea-json"},null,512),[[k,l.value.flowDefinition]]),e[14]||(e[14]=o("div",{class:"helper-text"}," 提示：流程定义采用JSON格式，包含nodes（节点）和edges（连线）两部分 ",-1))])]),o("div",{class:"dialog-actions"},[o("button",{onClick:T,class:"btn-primary"},"保存"),o("button",{onClick:N,class:"btn-secondary"},"取消")])])])):c("",!0),b.value?(i(),r("div",{key:1,class:"dialog-overlay",onClick:x},[o("div",{class:"dialog-large",onClick:e[5]||(e[5]=D(()=>{},["stop"]))},[o("h3",null,"查看流程: "+a(d.value.workflowName),1),o("div",pe,[o("div",we,[e[18]||(e[18]=o("h4",null,"基本信息",-1)),o("p",null,[e[15]||(e[15]=o("strong",null,"流程编号:",-1)),S(" "+a(d.value.workflowCode),1)]),o("p",null,[e[16]||(e[16]=o("strong",null,"关联产品:",-1)),S(" "+a(d.value.productCode),1)]),o("p",null,[e[17]||(e[17]=o("strong",null,"状态:",-1)),S(" "+a(d.value.status==="PUBLISHED"?"已发布":"草稿"),1)])]),o("div",me,[e[19]||(e[19]=o("h4",null,"流程定义",-1)),o("pre",ke,a(h(d.value.flowDefinition)),1)])]),o("div",{class:"dialog-actions"},[o("button",{onClick:x,class:"btn-secondary"},"关闭")])])])):c("",!0),_.value?(i(),r("div",{key:2,class:"dialog-overlay",onClick:O},[o("div",{class:"dialog",onClick:e[7]||(e[7]=D(()=>{},["stop"]))},[o("h3",null,"测试流程: "+a(y.value.workflowName),1),o("div",ge,[o("div",Ce,[e[20]||(e[20]=o("label",null,"测试上下文 (JSON格式):",-1)),m(o("textarea",{"onUpdate:modelValue":e[6]||(e[6]=t=>f.value=t),rows:"10",class:"form-textarea"},null,512),[[k,f.value]])])]),u.value?(i(),r("div",ye,[e[21]||(e[21]=o("h4",null,"执行结果:",-1)),o("pre",null,a(u.value),1)])):c("",!0),o("div",{class:"dialog-actions"},[o("button",{onClick:B,class:"btn-primary"},"执行测试"),o("button",{onClick:O,class:"btn-secondary"},"取消")])])])):c("",!0)]))}},Se=F(be,[["__scopeId","data-v-28b9839c"]]);export{Se as default};
